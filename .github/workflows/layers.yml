# This workflow will install dependencies and create a build suitable
# to be used in an AWS Lambda Layer.  The build will then be uploaded
# to S3 and then can be accessed from any lambda that uses the layer.

name: Build Lambda Layer 

on:
  push:
    paths:
      - .github/workflows/layers.yml
      -  python/requirements.txt

jobs:
  
  deploy:
    name: Upload Layer to AWS Lambda
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # For more info: https://github.com/aws-actions/configure-aws-credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{secrets.OPS_AWS_ACCESS_KEY_ID}}
          aws-secret-access-key: ${{secrets.OPS_AWS_SECRET_ACCESS_KEY}}
          aws-region: ${{secrets.AWS_DEFAULT_REGION}}

      - name: Setup Python 3.8
        uses: actions/setup-python@v1
        with:
          python-version: 3.8

      - name: Zip it all up and upload to S3
        env: 
          zip_name: lambda_deployment.zip
        run: |
          cd tf/configs/ops/lambda/layers
          docker run --rm \
            --volume=$(pwd):/lambda-build \
            -w=/lambda-build \
            lambci/lambda:build-python3.8 \
            pip install -r requirements.txt --target python
          zip -r $zip_name python      
          aws s3 cp $zip_name s3://ocurate-architecture/layers/